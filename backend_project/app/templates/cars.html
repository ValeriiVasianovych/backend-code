{% extends "base.html" %}

{% block title %}Available Cars - Car Rental Service{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">Available Cars</h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search cars...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="brandFilter">
                                <option value="">All Brands</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="priceFilter">
                                <option value="">Price Range</option>
                                <option value="0-50">$0 - $50</option>
                                <option value="51-100">$51 - $100</option>
                                <option value="101-200">$101 - $200</option>
                                <option value="201+">$201+</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="cars-container">
        <!-- Cars will be loaded here dynamically -->
    </div>
</div>

<!-- Car Details Modal -->
<div class="modal fade" id="carDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="carDetailsTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="carDetailsBody">
                <!-- Car details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="rentCarBtn">Rent Now</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allCars = [];
let selectedCarId = null;

async function loadCars() {
    try {
        const response = await fetch('/rentals/cars', {
            headers: getAuthHeader()
        });

        if (response.ok) {
            const data = await response.json();
            allCars = data.cars;
            displayCars(allCars);
            updateBrandFilter(allCars);
        } else if (response.status === 401) {
            const refreshed = await refreshToken();
            if (refreshed) {
                loadCars();
            } else {
                window.location.href = "{{ url_for('auth.login_page') }}";
            }
        }
    } catch (error) {
        console.error('Error loading cars:', error);
    }
}

function displayCars(cars) {
    const container = document.getElementById('cars-container');
    container.innerHTML = '';

    cars.forEach(car => {
        const carCard = `
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">${car.brand} ${car.model}</h5>
                        <p class="card-text">
                            <strong>Year:</strong> ${car.year}<br>
                            <strong>Color:</strong> ${car.color}<br>
                            <strong>Price per day:</strong> $${car.rental_price_per_day}
                        </p>
                        <button class="btn btn-primary" onclick="showCarDetails('${car._id}')">View Details</button>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += carCard;
    });
}

function updateBrandFilter(cars) {
    const brands = [...new Set(cars.map(car => car.brand))].sort();
    const brandFilter = document.getElementById('brandFilter');
    brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandFilter.appendChild(option);
    });
}

function filterCars() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const selectedBrand = document.getElementById('brandFilter').value;
    const priceRange = document.getElementById('priceFilter').value;

    let filteredCars = allCars.filter(car => {
        const matchesSearch = `${car.brand} ${car.model}`.toLowerCase().includes(searchTerm);
        const matchesBrand = !selectedBrand || car.brand === selectedBrand;
        const matchesPrice = !priceRange || isInPriceRange(car.rental_price_per_day, priceRange);
        return matchesSearch && matchesBrand && matchesPrice;
    });

    displayCars(filteredCars);
}

function isInPriceRange(price, range) {
    switch(range) {
        case '0-50': return price <= 50;
        case '51-100': return price > 50 && price <= 100;
        case '101-200': return price > 100 && price <= 200;
        case '201+': return price > 200;
        default: return true;
    }
}

function showCarDetails(carId) {
    const car = allCars.find(c => c._id === carId);
    if (!car) return;

    selectedCarId = carId;
    const modal = new bootstrap.Modal(document.getElementById('carDetailsModal'));
    
    document.getElementById('carDetailsTitle').textContent = `${car.brand} ${car.model}`;
    
    const detailsHtml = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Year:</strong> ${car.year}</p>
                <p><strong>Color:</strong> ${car.color}</p>
                <p><strong>Body Type:</strong> ${car.body_type}</p>
                <p><strong>Transmission:</strong> ${car.transmission}</p>
                <p><strong>Fuel Type:</strong> ${car.fuel_type}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Engine Volume:</strong> ${car.engine_volume}L</p>
                <p><strong>Engine Power:</strong> ${car.engine_power}hp</p>
                <p><strong>Mileage:</strong> ${car.mileage}km</p>
                <p><strong>Price per day:</strong> $${car.rental_price_per_day}</p>
                <p><strong>Available:</strong> ${car.available ? 'Yes' : 'No'}</p>
            </div>
        </div>
        ${car.features ? `<div class="mt-3"><strong>Features:</strong><br>${car.features.join(', ')}</div>` : ''}
    `;
    
    document.getElementById('carDetailsBody').innerHTML = detailsHtml;
    document.getElementById('rentCarBtn').disabled = !car.available;
    
    modal.show();
}

async function rentCar() {
    if (!selectedCarId) return;

    try {
        const response = await fetch(`/rentals/cars/${selectedCarId}/rent`, {
            method: 'POST',
            headers: {
                ...getAuthHeader(),
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            alert('Car rented successfully!');
            bootstrap.Modal.getInstance(document.getElementById('carDetailsModal')).hide();
            loadCars(); // Refresh the cars list
        } else if (response.status === 401) {
            const refreshed = await refreshToken();
            if (refreshed) {
                rentCar(); // Retry renting
            } else {
                window.location.href = "{{ url_for('auth.login_page') }}";
            }
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to rent car');
        }
    } catch (error) {
        console.error('Error renting car:', error);
        alert('An error occurred while trying to rent the car');
    }
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', filterCars);
document.getElementById('brandFilter').addEventListener('change', filterCars);
document.getElementById('priceFilter').addEventListener('change', filterCars);
document.getElementById('rentCarBtn').addEventListener('click', rentCar);

// Load cars when the page loads
document.addEventListener('DOMContentLoaded', loadCars);
</script>
{% endblock %} 